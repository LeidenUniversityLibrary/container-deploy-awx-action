name: Deploy container using AWX (reusable)

on:
  workflow_call:
    inputs:
      image:
        required: true
        type: string
      image_tag:
        required: true
        type: string
      quadlets_archive_b64:
        required: false
        type: string
      quadlets_repo:
        required: false
        type: string
      quadlets_ref:
        required: false
        type: string
      awx_secrets_b64:
        required: false
        type: string
      secret_names:
        required: false
        type: string

jobs:
  deploy-awx:
    runs-on:
      - oas-github-runner

    steps:
      - name: Launch AWX job
        id: launch
        env:
          AWX_JOB_URL: ${{ secrets.AWX_JOB_URL }}
          AWX_TOKEN: ${{ secrets.AWX_TOKEN }}
          IMAGE: ${{ inputs.image }}
          IMAGE_TAG: ${{ inputs.image_tag }}
          REGISTRY_USER: ${{ github.actor }}
          REGISTRY_TOKEN: ${{ github.token }}
          QUADLETS_ARCHIVE_B64: ${{ inputs.quadlets_archive_b64 }}
          QUADLETS_REPO: ${{ inputs.quadlets_repo }}
          QUADLETS_REF: ${{ inputs.quadlets_ref }}
          AWX_SECRETS_B64: ${{ inputs.awx_secrets_b64 }}
          SECRET_NAMES: ${{ inputs.secret_names }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Launching AWX deploy job (quadlets + secrets)"

          # Build base extra_vars JSON
          payload=$(jq -nc \
            --arg image "$IMAGE" \
            --arg image_tag "$IMAGE_TAG" \
            --arg registry_token "$REGISTRY_TOKEN" \
            --arg registry_user "$REGISTRY_USER" \
            '{
              extra_vars: {
                image: $image,
                image_tag: $image_tag,
                registry_token: $registry_token,
                registry_user: $registry_user
              }
            }'
          )

          # Add quadlets payload if provided
          if [ -n "${QUADLETS_ARCHIVE_B64:-}" ]; then
            payload=$(echo "$payload" | jq --arg q "$QUADLETS_ARCHIVE_B64" '.extra_vars.quadlets_archive_b64 = $q')
          fi
          if [ -n "${QUADLETS_REPO:-}" ]; then
            payload=$(echo "$payload" | jq --arg r "$QUADLETS_REPO" '.extra_vars.quadlets_repo = $r')
          fi
          if [ -n "${QUADLETS_REF:-}" ]; then
            payload=$(echo "$payload" | jq --arg ref "$QUADLETS_REF" '.extra_vars.quadlets_ref = $ref')
          fi

          # If AWX_SECRETS_B64 provided, decode and attach as extra_vars.secrets (JSON)
          if [ -n "${AWX_SECRETS_B64:-}" ]; then
            secrets_json="$(echo "$AWX_SECRETS_B64" | base64 -d)"
            if echo "$secrets_json" | jq -e . >/dev/null 2>&1; then
              payload=$(echo "$payload" | jq --argjson s "$secrets_json" '.extra_vars.secrets = $s')
            else
              echo "Warning: AWX_SECRETS_B64 decoded but is not valid JSON; skipping" >&2
            fi
          fi

          # If SECRET_NAMES provided, also attach as a CSV or list
          if [ -n "${SECRET_NAMES:-}" ]; then
            payload=$(echo "$payload" | jq --arg sn "$SECRET_NAMES" '.extra_vars.secret_names = $sn')
          fi

          # Post the job to AWX
          resp="$(curl -sSf -X POST \
            -H "Authorization: Bearer ${AWX_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "${payload}" \
            "${AWX_JOB_URL}")"

          echo "$resp"
          job_id="$(echo "$resp" | jq -r '.job')"
          if [[ -z "$job_id" || "$job_id" == "null" ]]; then
            echo "Failed to parse job id from AWX response" >&2
            exit 1
          fi
          echo "job_id=${job_id}" >> "$GITHUB_OUTPUT"

      - name: Wait for AWX & stream logs
        env:
          AWX_JOB_URL: ${{ secrets.AWX_JOB_URL }}
          JOB_ID: ${{ steps.launch.outputs.job_id }}
          AWX_TOKEN: ${{ secrets.AWX_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          AWX_URL="${AWX_JOB_URL%%/api/*}"
          echo "Waiting for AWX job ${JOB_ID} ..."
          while :; do
            status="$(curl -sS -H "Authorization: Bearer ${AWX_TOKEN}" \
              "${AWX_URL}/api/v2/jobs/${JOB_ID}/" | jq -r '.status')"
            echo "Status: ${status}"
            case "$status" in
              successful|failed|error|canceled) break ;;
            esac
            sleep 10
          done

          echo "----- AWX job ${JOB_ID} output -----"
          curl -sS -H "Authorization: Bearer ${AWX_TOKEN}" \
            "${AWX_URL}/api/v2/jobs/${JOB_ID}/stdout/?format=txt"

          if [[ "$status" != "successful" ]]; then
            echo "AWX job ended with status: $status" >&2
            exit 1
          fi