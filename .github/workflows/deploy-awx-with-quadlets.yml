name: Deploy container using AWX (reusable)

on:
  workflow_call:
    inputs:
      image:
        required: true
        type: string
      image_tag:
        required: true
        type: string
      quadlets_archive_b64:
        required: false
        type: string
      quadlets_repo:
        required: false
        type: string
      quadlets_ref:
        required:   false
        type: string
      env_enc_b64:
        required:  false
        type: string

jobs:
  deploy-awx:
    runs-on:
      - oas-github-runner

    steps:
      - name:   Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name:   Decrypt .env.enc to . env. dec
        id: decrypt_env
        env:
          FERNET_KEY: ${{ secrets. FERNET_KEY }}
          ENV_ENC_B64: ${{ inputs.env_enc_b64 }}
        shell:  bash
        run: |
          set -euo pipefail
          
          if [ -n "${ENV_ENC_B64:-}" ]; then
            echo "Decrypting .env.enc..."
            echo "$ENV_ENC_B64" | base64 -d > .env.enc
          
            # Install cryptography
            pip install cryptography
          
            python3 << 'EOF'
          from cryptography.fernet import Fernet, InvalidToken
          import os
          import sys
          
          try:
            fernet_key = os.environ['FERNET_KEY']
          
            # Validate the key format
            if not fernet_key: 
              print("ERROR: FERNET_KEY is empty", file=sys.stderr)
              sys.exit(1)
          
            # Check key length (Fernet keys should be 44 bytes base64 encoded = 32 bytes raw)
            print(f"Fernet key length: {len(fernet_key)} characters")
          
            cipher = Fernet(fernet_key.encode())
          
            with open('.env.enc', 'rb') as f:
              encrypted_data = f.read()
          
            print(f"Encrypted data size: {len(encrypted_data)} bytes")
          
            # Attempt decryption
            decrypted = cipher.decrypt(encrypted_data)
          
            with open('.env.dec', 'wb') as f:
              f.write(decrypted)
          
            print("âœ“ Successfully decrypted .env.enc to .env.dec")
          
          except InvalidToken: 
            print("ERROR: Invalid Fernet token.  Possible causes:", file=sys.stderr)
            print("  1. Wrong FERNET_KEY (doesn't match the key used for encryption)", file=sys.stderr)
            print("  2. Corrupted encrypted data", file=sys.stderr)
            print("  3. Data was not encrypted with Fernet", file=sys.stderr)
            sys.exit(1)
          except Exception as e:
            print(f"ERROR: Unexpected error during decryption: {e}", file=sys.stderr)
            sys.exit(1)
          EOF
          
            base64 -w0 .env.dec > env_dec. b64
            echo "env_dec_b64=$(cat env_dec.b64)" >> "$GITHUB_OUTPUT"
          else
            echo "No encrypted env file provided, skipping decryption"
            echo "env_dec_b64=" >> "$GITHUB_OUTPUT"
          fi

      - name: Launch AWX job
        id: launch
        env:
          AWX_JOB_URL: ${{ secrets.AWX_JOB_URL }}
          AWX_TOKEN: ${{ secrets.AWX_TOKEN }}
          IMAGE: ${{ inputs.image }}
          IMAGE_TAG: ${{ inputs.image_tag }}
          REGISTRY_USER: ${{ github.actor }}
          REGISTRY_TOKEN: ${{ github.token }}
          QUADLETS_ARCHIVE_B64: ${{ inputs. quadlets_archive_b64 }}
          QUADLETS_REPO: ${{ inputs.quadlets_repo }}
          QUADLETS_REF: ${{ inputs. quadlets_ref }}
          ENV_DEC_B64: ${{ steps.decrypt_env.outputs.env_dec_b64 }}
          FERNET_KEY: ${{ secrets.FERNET_KEY }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Launching AWX deploy job (quadlets + secrets)"
          
          payload=$(jq -nc \
            --arg image "$IMAGE" \
            --arg image_tag "$IMAGE_TAG" \
            --arg registry_token "$REGISTRY_TOKEN" \
            --arg registry_user "$REGISTRY_USER" \
            '{
              extra_vars: {
                image: $image,
                image_tag: $image_tag,
                registry_token: $registry_token,
                registry_user:   $registry_user
              }
            }'
          )
          
          if [ -n "${QUADLETS_ARCHIVE_B64:-}" ]; then
            payload=$(echo "$payload" | jq --arg q "$QUADLETS_ARCHIVE_B64" '. extra_vars.quadlets_archive_b64 = $q')
          fi
          if [ -n "${QUADLETS_REPO:-}" ]; then
            payload=$(echo "$payload" | jq --arg r "$QUADLETS_REPO" '.extra_vars. quadlets_repo = $r')
          fi
          if [ -n "${QUADLETS_REF:-}" ]; then
            payload=$(echo "$payload" | jq --arg ref "$QUADLETS_REF" '.extra_vars. quadlets_ref = $ref')
          fi
          
          if [ -n "${ENV_DEC_B64:-}" ]; then
            payload=$(echo "$payload" | jq --arg e "$ENV_DEC_B64" '. extra_vars.env_dec_b64 = $e')
          fi
          
          if [ -n "${FERNET_KEY:-}" ]; then
            echo "FERNET_KEY is set"
            payload=$(echo "$payload" | jq --arg fk "$FERNET_KEY" '. extra_vars.fernet_key = $fk')
            echo "Fernet key added to payload"
          else
            echo "FERNET_KEY is not set"
          fi
          
          resp="$(curl -sSf -X POST \
            -H "Authorization: Bearer ${AWX_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "${payload}" \
            "${AWX_JOB_URL}")"
          
          echo "$resp"
          job_id="$(echo "$resp" | jq -r '.job')"
          if [[ -z "$job_id" || "$job_id" == "null" ]]; then
            echo "Failed to parse job id from AWX response" >&2
            exit 1
          fi
          echo "job_id=${job_id}" >> "$GITHUB_OUTPUT"

      - name: Wait for AWX & stream logs
        env:
          AWX_JOB_URL: ${{ secrets.AWX_JOB_URL }}
          JOB_ID: ${{ steps.launch.outputs.job_id }}
          AWX_TOKEN: ${{ secrets.AWX_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          AWX_URL="${AWX_JOB_URL%%/api/*}"
          echo "Waiting for AWX job ${JOB_ID} ..."
          while :  ; do
            status="$(curl -sS -H "Authorization:  Bearer ${AWX_TOKEN}" \
              "${AWX_URL}/api/v2/jobs/${JOB_ID}/" | jq -r '.status')"
            echo "Status:  ${status}"
            case "$status" in
              successful|failed|error|canceled) break ;;
            esac
            sleep 10
          done
          
          echo "----- AWX job ${JOB_ID} output -----"
          curl -sS -H "Authorization:  Bearer ${AWX_TOKEN}" \
            "${AWX_URL}/api/v2/jobs/${JOB_ID}/stdout/?format=txt"
          
          if [[ "$status" != "successful" ]]; then
            echo "AWX job ended with status: $status" >&2
            exit 1
          fi